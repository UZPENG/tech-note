# Java多线程
## 1.操作系统的进程和线程
### 1.1基本概念
进程是资源分配（内存、文件描述符）的基本单位，线程是轻量级的进程，线程拥有独立的PC和栈，但是共享同一进程的资源，线程是系统调度的基本单位。其实在本质上，线程是把进程的资源分配和调度执行两个属性分割，进程仅仅拥有资源，线程共享进程资源并且成为处理机调度的基本单位，从而提高并发性。

注意：如果是单核处理器，一般单线程的执行效率会比多线程高，因为线程的调度存在上下文切换需要额外的时间。但是线程在多核上，多线程优于单线程，因为能够充分利用多个处理单位。


### 1.2进程通信的机制
1. 管道
2. 共享内存
3. 消息队列
4. socket

### 1.3进程的状态管理
就绪、运行、挂起、阻塞、结束

## 2.多线程编程的优缺点
优点：
1. 很简单地就能实现异步。
2. 能够充分利用多个处理器。
3. 提供交互的高响应。

缺点：
1. 安全性。竞态条件：当多个线程访问共享资源时，如果没有同步，会造成结果不正确。
2. 活跃性。实现得不好可能会出现饥饿、死锁、活锁等情况。
3. 性能。主要是线程调度会带来上下文切换的开销。

## 3.线程安全
本质是管理共享（可以被多个线程访问）、可变（在其生命周期内会发生改变）的状态。

线程安全的类：在任意调度、交替执行且无同步和协调的情况下，类的行为能保持正确。

原子操作：要么不执行，要么执行完，操作过程中不会被调度。

组合操作。

可重入锁：同一个线程申请锁时，计数器加一，可以进入临界区。

锁：sychronized Java内部锁。

## 4.共享对象
可见性：任意一个线程的修改都能作用于其他线程，不会出现过期的数据。也就是说当A线程修改了某一共享变量的值时，B线程总能读到最新的值。

加锁可以保证可见性和原子性。

volatile关键字：保证修饰的变量是可见的。一般满足以下几种情况可以使用：
1. 除了可见性外，没有其他原因需要加锁。
2. 写入变量事不依赖之前的状态 。
3. 不需要和其他变量参与不变性约束。

发布和逸出
发布：使得一个对象能被当前范围外的代码访问。
逸出：一个对象尚未准备好时就将它发布。

比如匿名内部类this指针逸出，public方法逸出private域

线程封闭
1. 使用一个线程
2. 栈中的内容
3. 使用ThreadLocal

不可变的对象永远是安全的。
